steps:
  # 1. ì˜ì¡´ì„± ì„¤ì¹˜
  - name: 'node:18'
    entrypoint: 'npm'
    args: ['ci']

  # 2. ë¹Œë“œ
  - name: 'node:18'
    entrypoint: 'npm'
    args: ['run', 'build']

  # 3. ì••ì¶•, GCS ì—…ë¡œë“œ, startup.sh ì—…ë¡œë“œ, í…œí”Œë¦¿ ìƒì„±, MIG ì—…ë°ì´íŠ¸
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ dist.tar.gz ìƒì„±"
        tar -czf dist.tar.gz -C dist .

        echo "â˜ï¸ dist.tar.gz ì—…ë¡œë“œ"
        gsutil cp dist.tar.gz gs://vue-pension-builder-bucket/dist/dist.tar.gz

        echo "ğŸ“ startup.sh ì—…ë¡œë“œ"
        gsutil cp startup.sh gs://vue-pension-builder-bucket/scripts/startup.sh

        echo "ğŸ§± ì¸ìŠ¤í„´ìŠ¤ í…œí”Œë¦¿ ìƒì„±"
        TIMESTAMP=$(date +%s)
        TEMPLATE_NAME=vue-template-$TIMESTAMP

        gcloud compute instance-templates create $TEMPLATE_NAME \
          --machine-type=e2-micro \
          --image-family=debian-11 \
          --image-project=debian-cloud \
          --metadata=startup-script-url=gs://vue-pension-builder-bucket/scripts/startup.sh \
          --service-account=vue-vm-sa@affable-heading-456202-r3.iam.gserviceaccount.com \
          --scopes=https://www.googleapis.com/auth/cloud-platform \
          --tags=http-server

        echo "ğŸ” MIG ë¡¤ë§ ì—…ë°ì´íŠ¸"
        gcloud compute instance-groups managed rolling-action start-update instance-group-3 \
          --version=template=$TEMPLATE_NAME \
          --zone=asia-northeast3-a

timeout: 900s
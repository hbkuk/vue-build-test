steps:
  # 1. ì˜ì¡´ì„± ì„¤ì¹˜
  - name: 'node:18'
    entrypoint: 'npm'
    args: ['ci']

  # 2. Vite ë¹Œë“œ
  - name: 'node:18'
    entrypoint: 'npm'
    args: ['run', 'build']

  # 3. ì²« ë²ˆì§¸ VM ë°°í¬ + ë¡œê·¸
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ ë³µì‚¬: ì²« ë²ˆì§¸ VMìœ¼ë¡œ dist/ ì „ì†¡ ì‹œì‘"
        gcloud compute scp --recurse dist/ instance-group-2-06h1:/tmp/dist --zone=asia-northeast3-a

        echo "ğŸš€ ë³µì‚¬ ì™„ë£Œ. ì²« ë²ˆì§¸ VMì—ì„œ /tmp/dist ë‚´ìš© í™•ì¸:"
        gcloud compute ssh instance-group-2-06h1 --zone=asia-northeast3-a --command="ls -al /tmp/dist"

        echo "ğŸ› ï¸ nginx ë””ë ‰í† ë¦¬ ë®ì–´ì“°ê¸° ì§„í–‰ ì¤‘..."
        gcloud compute ssh instance-group-2-06h1 --zone=asia-northeast3-a --command="
          sudo rm -rf /var/www/html/* &&
          sudo cp -r /tmp/dist/* /var/www/html/ &&
          echo 'âœ… ì²« ë²ˆì§¸ VMì— ë³µì‚¬ ì™„ë£Œ: /var/www/html ìƒíƒœ:' &&
          ls -al /var/www/html/"

  # 4. ë‘ ë²ˆì§¸ VM ë°°í¬ + ë¡œê·¸
  - name: 'gcr.io/cloud-builders/gcloud'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "ğŸ“¦ ë³µì‚¬: ë‘ ë²ˆì§¸ VMìœ¼ë¡œ dist/ ì „ì†¡ ì‹œì‘"
        gcloud compute scp --recurse dist/ instance-group-2-9mdh:/tmp/dist --zone=asia-northeast3-a

        echo "ğŸš€ ë³µì‚¬ ì™„ë£Œ. ë‘ ë²ˆì§¸ VMì—ì„œ /tmp/dist ë‚´ìš© í™•ì¸:"
        gcloud compute ssh instance-group-2-9mdh --zone=asia-northeast3-a --command="ls -al /tmp/dist"

        echo "ğŸ› ï¸ nginx ë””ë ‰í† ë¦¬ ë®ì–´ì“°ê¸° ì§„í–‰ ì¤‘..."
        gcloud compute ssh instance-group-2-9mdh --zone=asia-northeast3-a --command="
          sudo rm -rf /var/www/html/* &&
          sudo cp -r /tmp/dist/* /var/www/html/ &&
          echo 'âœ… ë‘ ë²ˆì§¸ VMì— ë³µì‚¬ ì™„ë£Œ: /var/www/html ìƒíƒœ:' &&
          ls -al /var/www/html/"

options:
  logging: CLOUD_LOGGING_ONLY
# 1. npm install        â†’ node_modules
# 2. npm run build      â†’ dist ìƒì„±
# 3. docker build       â†’ dist í¬í•¨ëœ nginx ì´ë¯¸ì§€ ìƒì„±
# 4. docker push        â†’ ì»¤ë°‹ í•´ì‹œ ê¸°ë°˜ ì´ë¯¸ì§€ í‘¸ì‹œ
# 5. tag latest & push  â†’ ìµœì‹  ë²„ì „ë„ ìœ ì§€

steps:
  # 1. Vue ì„¤ì¹˜
  - name: 'node:lts'
    args:
      - install
    entrypoint: npm

  # 2. ë¹Œë“œ
  - name: 'node:lts'
    args:
      - run
      - build
    entrypoint: npm

  # 3. Docker ë¹Œë“œ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', 'asia-northeast3-docker.pkg.dev/affable-heading-456202-r3/vm-docker/vue-nginx:$SHORT_SHA', '.']

  # 4. ì»¤ë°‹ í•´ì‹œ ë²„ì „ ì´ë¯¸ì§€ í‘¸ì‹œ
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-northeast3-docker.pkg.dev/affable-heading-456202-r3/vm-docker/vue-nginx:$SHORT_SHA']

  # 5. latest íƒœê·¸ë¡œ ì´ë¯¸ì§€ ì¶”ê°€
  - name: 'gcr.io/cloud-builders/docker'
    args: ['tag', 'asia-northeast3-docker.pkg.dev/affable-heading-456202-r3/vm-docker/vue-nginx:$SHORT_SHA', 'asia-northeast3-docker.pkg.dev/affable-heading-456202-r3/vm-docker/vue-nginx:latest']

  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', 'asia-northeast3-docker.pkg.dev/affable-heading-456202-r3/vm-docker/vue-nginx:latest']


  # 6. MIG ë¬´ì¤‘ë‹¨ ì¬ì‹œì‘ (ìµœì‹  ì´ë¯¸ì§€ ë°˜ì˜ìš©)
  - name: 'gcr.io/google.com/cloudsdktool/cloud-sdk'
    entrypoint: 'bash'
    args:
      - -c
      - |
        echo "ğŸ” MIG ë¬´ì¤‘ë‹¨ ë¡¤ë§ ì¬ì‹œì‘ ì‹œì‘"
        gcloud compute instance-groups managed rolling-action restart instance-group-4 \
          --zone=asia-northeast3-a \
          --max-unavailable=1

timeout: 900s
options:
  logging: CLOUD_LOGGING_ONLY
